<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to ASCII Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Image to ASCII Converter</h1>
            <p>Transform your images into ASCII art</p>
        </header>

        <div class="main-content">
            <aside class="controls">
                <div class="control-section" data-section="image-source">
                    <h3>Media Source</h3>
                    <div class="section-content">
                        <div class="drop-zone" id="drop-zone">
                            <div class="drop-zone-icon">üìÅ</div>
                            <div class="drop-zone-text">
                                <strong>Click to upload</strong> or drag & drop
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">Images or videos</div>
                            </div>
                        </div>
                        <input type="file" id="file-input" accept="image/*,video/*">

                        <div class="url-input-group">
                            <input type="text" id="url-input" placeholder="Or paste image URL..." autocomplete="off" spellcheck="false">
                            <button class="btn btn-primary" id="load-url-btn">Load</button>
                        </div>

                        <div class="preview-section">
                            <h4>Preview</h4>
                            <img id="image-preview" alt="Preview">
                            <video id="video-preview" muted playsinline style="display: none; max-width: 100%; border-radius: 4px;"></video>
                            <div id="no-preview" style="font-size: 0.85rem; color: var(--text-secondary);">No media loaded</div>
                        </div>

                        <div class="video-controls" id="video-controls" style="display: none;">
                            <div class="copy-buttons" style="margin-bottom: 8px;">
                                <button class="btn btn-secondary" id="video-play-btn">‚ñ∂ Play</button>
                                <button class="btn btn-secondary" id="video-pause-btn" style="display: none;">‚è∏ Pause</button>
                                <button class="btn btn-secondary" id="video-stop-btn">‚èπ Stop</button>
                            </div>
                            <div class="setting-row" style="margin-bottom: 8px;">
                                <input type="range" id="video-seek" min="0" max="100" value="0" style="flex: 1;">
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--text-secondary);">
                                <span id="video-time">0:00 / 0:00</span>
                                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;">
                                    <input type="checkbox" id="video-loop"> Loop
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-section" data-section="settings-presets">
                    <h3>Settings Presets</h3>
                    <div class="section-content">
                        <div class="setting-row">
                            <label for="settings-preset">Preset</label>
                            <select id="settings-preset" style="flex: 1;">
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                        <div class="copy-buttons" style="margin-top: 8px;">
                            <button class="btn btn-secondary" id="save-settings-preset-btn">Save Current</button>
                            <button class="btn btn-secondary" id="delete-settings-preset-btn" style="display: none;">Delete</button>
                        </div>
                    </div>
                </div>

                <div class="control-section" data-section="display-settings">
                    <h3>Display Settings</h3>
                    <div class="section-content">
                        <div class="setting-row">
                            <label for="theme-select">Theme</label>
                            <select id="theme-select">
                                <option value="auto">Auto (System)</option>
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>

                        <div class="setting-row">
                            <label for="chars-per-row">Characters per row</label>
                            <input type="range" id="chars-per-row" min="20" max="300" value="100">
                            <div class="setting-value"><span id="chars-value">100</span></div>
                        </div>

                        <div class="setting-row">
                            <label for="font-size" style="display: flex; align-items: center; gap: 6px;">
                                <span>Font Size</span>
                                <span style="font-weight: normal; color: var(--text-secondary); display: inline-flex; align-items: center;">(<input type="checkbox" id="auto-fit-font" style="margin: 0 4px 0 0;"><span style="cursor: pointer;" onclick="document.getElementById('auto-fit-font').click()">auto-fit</span>)</span>
                            </label>
                            <input type="range" id="font-size" min="4" max="20" value="10">
                            <div class="setting-value"><span id="font-size-value">10</span>px</div>
                        </div>

                        <div class="setting-row">
                            <label for="font-family">Font</label>
                            <select id="font-family">
                                <!-- Populated dynamically based on available fonts -->
                            </select>
                        </div>

                        <div class="setting-row">
                            <label for="char-ratio" style="display: flex; align-items: center; gap: 6px;">
                                <span>Char Ratio</span>
                                <span style="font-weight: normal; color: var(--text-secondary); display: inline-flex; align-items: center;">(<input type="checkbox" id="auto-ratio" checked style="margin: 0 4px 0 0;"><span style="cursor: pointer;" onclick="document.getElementById('auto-ratio').click()">auto</span>)</span>
                            </label>
                            <input type="range" id="char-ratio" step="0.05" min="0.3" max="1.0" value="0.5">
                            <div class="setting-value"><span id="char-ratio-value">0.5</span></div>
                        </div>
                    </div>
                </div>

                <div class="control-section" data-section="algorithm">
                    <h3>Algorithm</h3>
                    <div class="section-content">
                        <div class="setting-row">
                            <label for="algorithm">Method</label>
                            <select id="algorithm">
                                <option value="brightness">Brightness Mapping</option>
                                <option value="dithering">Floyd-Steinberg Dithering</option>
                                <option value="pattern">Block Pattern Matching</option>
                                <option value="edge">Edge Detection</option>
                            </select>
                        </div>

                        <div class="algo-settings" id="algo-settings">
                            <!-- Character Set (shared by brightness and dithering) -->
                            <div class="algo-settings-panel" id="settings-charset">
                                <div class="setting-row">
                                    <label for="char-set">Character Set</label>
                                    <div class="inline-group">
                                        <select id="char-set" style="flex: 1;">
                                            <optgroup label="Built-in">
                                                <option value="standard">Standard</option>
                                                <option value="detailed">Detailed</option>
                                                <option value="blocks">Blocks</option>
                                                <option value="simple">Simple</option>
                                            </optgroup>
                                            <optgroup label="Custom" id="char-set-custom-group">
                                            </optgroup>
                                        </select>
                                        <button class="btn btn-secondary btn-small" id="save-chars-btn" title="Save current characters as preset">Save</button>
                                        <button class="btn btn-secondary btn-small" id="delete-chars-btn" title="Delete selected custom preset" style="display: none;">Del</button>
                                    </div>
                                </div>
                                <div class="setting-row">
                                    <label for="custom-chars">Characters (dark to light)</label>
                                    <input type="text" id="custom-chars" value="@%#+=*-:. " placeholder="Characters dark to light" autocomplete="off" spellcheck="false">
                                </div>
                                <div class="setting-row">
                                    <div class="inline-group">
                                        <button class="btn btn-secondary btn-small" id="sort-chars-btn" title="Sort characters by visual brightness">Sort</button>
                                        <label for="reduce-count" style="margin: 0; white-space: nowrap;">Reduce to</label>
                                        <input type="number" id="reduce-count" min="0" max="100" value="0" style="width: 60px;" title="0 = no reduction">
                                        <span style="font-size: 0.85rem; color: var(--text-secondary);">chars</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Dithering Settings -->
                            <div class="algo-settings-panel" id="settings-dithering">
                                <div class="setting-row">
                                    <label for="dither-strength">Error Diffusion Strength</label>
                                    <input type="range" id="dither-strength" min="0" max="100" value="100">
                                    <div class="setting-value"><span id="dither-strength-value">100</span>%</div>
                                </div>
                            </div>

                            <!-- Edge Detection Settings -->
                            <div class="algo-settings-panel" id="settings-edge">
                                <div class="setting-row">
                                    <label for="edge-threshold">Edge Threshold</label>
                                    <input type="range" id="edge-threshold" min="10" max="200" value="50">
                                    <div class="setting-value"><span id="edge-threshold-value">50</span></div>
                                </div>
                            </div>

                            <!-- Pattern Matching Settings -->
                            <div class="algo-settings-panel" id="settings-pattern">
                                <div class="setting-row">
                                    <label for="pattern-block-size">Block Size</label>
                                    <select id="pattern-block-size">
                                        <option value="2">2x2</option>
                                        <option value="3" selected>3x3</option>
                                        <option value="4">4x4</option>
                                    </select>
                                </div>
                                <div class="setting-row">
                                    <label for="pattern-chars">Character Pool</label>
                                    <input type="text" id="pattern-chars" value="@#$%&8BMW*oahkbdpqwmZO0QCJYXzcvunxrjft/\|()1{}[]?-_+~<>i!lI;:,. " placeholder="Characters to use" autocomplete="off" spellcheck="false">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-section" data-section="output-settings">
                    <h3>Output Settings</h3>
                    <div class="section-content">
                        <div class="setting-row">
                            <label for="color-mode">Color Mode</label>
                            <select id="color-mode">
                                <option value="monochrome">Monochrome</option>
                                <option value="truecolor">True color</option>
                                <option value="adaptive4">Adaptive 4 colors</option>
                                <option value="adaptive8">Adaptive 8 colors</option>
                                <option value="adaptive16">Adaptive 16 colors</option>
                                <option value="adaptive256">Adaptive 256 colors</option>
                                <option value="ansi256">ANSI 256 colors</option>
                            </select>
                        </div>

                        <div class="setting-row mono-settings">
                            <label>Colors</label>
                            <div class="inline-group">
                                <input type="color" id="mono-fg" value="#f0f0f0" title="Foreground">
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">FG</span>
                                <input type="color" id="mono-bg" value="#0d0d0d" title="Background">
                                <span style="font-size: 0.85rem; color: var(--text-secondary);">BG</span>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="checkbox-row">
                                <input type="checkbox" id="invert-brightness">
                                <label for="invert-brightness" style="margin: 0;">Invert brightness</label>
                            </div>
                        </div>

                        <div class="setting-row">
                            <div class="checkbox-row">
                                <input type="checkbox" id="contrast-histogram">
                                <label for="contrast-histogram" style="margin: 0;">Histogram equalization</label>
                            </div>
                        </div>

                        <div class="setting-row">
                            <label for="contrast-amount">Contrast</label>
                            <input type="range" id="contrast-amount" min="50" max="300" value="100">
                            <div class="setting-value"><span id="contrast-amount-value">100</span>%</div>
                        </div>

                        <div class="setting-row color-slider">
                            <label for="brightness-blend">Brightness blend</label>
                            <input type="range" id="brightness-blend" min="0" max="100" value="50">
                            <div class="setting-value"><span id="brightness-blend-value">50</span>%</div>
                        </div>

                        <div class="setting-row color-slider">
                            <label for="color-saturation">Saturation</label>
                            <input type="range" id="color-saturation" min="0" max="200" value="100">
                            <div class="setting-value"><span id="color-saturation-value">100</span>%</div>
                        </div>

                        <div class="setting-row">
                            <label for="global-opacity">Opacity</label>
                            <input type="range" id="global-opacity" min="5" max="100" value="100">
                            <div class="setting-value"><span id="global-opacity-value">100</span>%</div>
                        </div>

                        <div class="setting-row">
                            <div class="checkbox-row">
                                <input type="checkbox" id="brightness-opacity">
                                <label for="brightness-opacity" style="margin: 0;">Brightness as opacity</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-section" data-section="export">
                    <h3>Export</h3>
                    <div class="section-content">
                        <div class="copy-buttons">
                            <button class="btn btn-secondary" id="copy-text-btn">Copy Text</button>
                            <button class="btn btn-secondary" id="copy-html-btn">Copy HTML</button>
                        </div>
                        <div class="copy-buttons" style="margin-top: 8px;">
                            <button class="btn btn-secondary" id="copy-markdown-btn">Copy Markdown</button>
                            <button class="btn btn-primary" id="download-png-btn">Download PNG</button>
                        </div>
                        <div class="copy-buttons" id="gif-export-controls" style="margin-top: 8px; display: none;">
                            <button class="btn btn-primary" id="download-gif-btn">Record GIF</button>
                            <button class="btn btn-primary" id="download-video-btn">Record Video</button>
                            <button class="btn btn-secondary" id="video-preferences-btn" title="Video Preferences">‚öô</button>
                            <span id="gif-status" style="font-size: 12px; color: var(--text-muted);"></span>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="output-area">
                <div class="output-header">
                    <h2>ASCII Output</h2>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="loading-inline" id="loading">
                            <div class="spinner-small"></div>
                            <span>Converting...</span>
                        </div>
                        <span class="output-info" id="output-info"></span>
                        <span class="output-info" id="video-fps" style="display: none;"></span>
                    </div>
                </div>

                <div class="ascii-container">
                    <div class="placeholder-message" id="placeholder">
                        <div class="icon">üñºÔ∏è</div>
                        <div>Loading...</div>
                    </div>
                    <div id="ascii-output"></div>
                    <canvas id="ascii-canvas" style="display: none;"></canvas>
                </div>
            </main>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Video Settings Modal -->
    <div class="modal-overlay" id="video-settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Preferences</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Format</label>
                    <select id="video-format">
                        <option value="webm-vp9">WebM (VP9) - Best quality</option>
                        <option value="webm-vp8">WebM (VP8) - Compatible</option>
                        <option value="mp4">MP4 (H.264) - Safari</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Quality</label>
                    <select id="video-quality">
                        <option value="high">High (8 Mbps)</option>
                        <option value="medium" selected>Medium (5 Mbps)</option>
                        <option value="low">Low (2 Mbps)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Frame Rate</label>
                    <select id="video-framerate">
                        <option value="60">60 FPS</option>
                        <option value="30" selected>30 FPS</option>
                        <option value="24">24 FPS (Cinematic)</option>
                        <option value="15">15 FPS (Small file)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label>Max Duration</label>
                    <select id="video-duration">
                        <option value="10">10 seconds</option>
                        <option value="30" selected>30 seconds</option>
                        <option value="60">60 seconds</option>
                        <option value="120">2 minutes</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="modal-close-save">Close</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
